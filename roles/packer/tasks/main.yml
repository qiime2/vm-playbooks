---
# This role sets up the necessary user environments for aws and vbox

vars:
  paths:
    - /etc/skel
    - '~'
  bashrclines:
    - export PATH="{{ miniconda_path }}/bin:$PATH"
    - source tab-qiime
  matplotlibrclines:
    - { path: '.config', state: 'directory'}
    - { path: '.config/matplotlib', state: 'directory'}
    - { path: '.config/matplotlib/matplotlibrc', state: 'touch' }

- name: set up .bashrc
  become: true
  lineinfile:
    dest: "{{ item[0] }}/.bashrc"
    line: "{{ item[1] }}"
  with_nested:
    - paths
    - bashrclines

- name: create matplotlib config dirs
  become: true
  file:
    path: "{{ item[0] }}/{{ item[1].path }}"
    state: "{{ item[1].state }}"
  with_nested:
    - paths
    - matplotlibrclines

- name: set up matplotlibrc
  become: true
  lineinfile:
    dest: "{{ item }}/.config/matplotlib/matplotlibrc"
    line: "backend: agg"
  with_items: "{{ paths }}"

- name: set up ssh (general)
  become: true
  lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - { regexp: '^PasswordAuthentication.*$', line: 'PasswordAuthentication yes' }
    - { regexp: '^.*Port.*$', line: 'Port 22' }

- name: restart ssh
  become: true
  service:
    name: ssh
    state: restarted

- name: create user account
  become: true
  user:
    name: "{{ ssh_username }}"
    password: "{{ ssh_password }}"
    shell: /bin/bash
    groups: sudo
