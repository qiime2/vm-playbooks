{
  "variables": {
    "ssh_username": "qiime2",
    "ssh_password": "qiime2",
    "ssh_fullname": "QIIME 2 User",
    "hostname": "qiime2"
  },

  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "echo 'export PATH=/miniconda3/bin:$PATH' | tee -a /root/.bashrc /root/.profile /etc/profile",
        "echo 'export PATH=/miniconda3/bin:$PATH' > /etc/environment",
        "echo 'export PATH=/miniconda3/bin:$PATH' > /etc/profile.d/conda.sh",
        "echo 'export LC_ALL=C.UTF-8' | tee -a /root/.bashrc /root/.profile /etc/profile /etc/environment /etc/profile.d/conda.sh",
        "echo 'export LANG=C.UTF-8' | tee -a /root/.bashrc /root/.profile /etc/profile /etc/environment /etc/profile.d/conda.sh",
        "pip install -U ansible"
      ],
      "only": ["docker"]
    },
    {
      "type": "ansible-local",
      "playbook_file": "./playbooks/packer-qiime2.yml",
      "inventory_groups": "default",
      "extra_arguments": [
        "--extra-vars \"miniconda_path=/miniconda3\""
      ],
      "role_paths": [
        "./roles/qiime2"
      ]
    }
  ],

  "builders": [
    {
      "type": "virtualbox-iso",
      "guest_os_type": "Ubuntu_64",

      "iso_urls": [
        "./iso/ubuntu-16.04.1-server-amd64.iso",
        "http://releases.ubuntu.com/16.04/ubuntu-16.04.1-server-amd64.iso"
      ],
      "iso_checksum": "d2d939ca0e65816790375f6826e4032f",
      "iso_checksum_type": "md5",

      "http_directory" : "http",
      "disk_size" : 10000,

      "ssh_wait_timeout": "20m",
      "ssh_username": "{{ user `ssh_username` }}",
      "ssh_password": "{{ user `ssh_password` }}",

      "shutdown_command": "echo {{user `ssh_password`}} | sudo -S shutdown -P now",
      "boot_command" : [
        "<enter><wait><f6><esc><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs><bs>",
        "/install/vmlinuz noapic<wait>",
        " preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/preseed.cfg<wait>",
        " debian-installer=en_US auto locale=en_US kbd-chooser/method=us<wait>",
        " hostname={{ user `hostname` }}<wait>",
        " fb=false debconf/frontend=noninteractive<wait>",
        " keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA<wait>",
        " keyboard-configuration/variant=USA console-setup/ask_detect=false<wait>",
        " passwd/user-fullname={{ user `ssh_fullname` }}<wait>",
        " passwd/user-password={{ user `ssh_password` }}<wait>",
        " passwd/user-password-again={{ user `ssh_password` }}<wait>",
        " passwd/username={{ user `ssh_username` }}<wait>",
        " initrd=/install/initrd.gz --- <enter><wait>"
      ]
    },
    {
      "type": "docker",
      "image": "python:3.5",
      "commit": "true"
    }
  ],
  "post-processors": [
    {
      "type": "docker-tag",
      "repository": "qiime2/core",
      "tag": "2.0.6",
      "only": ["docker"]
    },
    {
      "type": "docker-tag",
      "repository": "qiime2/core",
      "tag": "latest",
      "only": ["docker"]
    },
    {
      "type": "shell-local",
      "inline": [
        "docker run -i -t -d --name q2 qiime2/core:latest /bin/bash",
	"docker commit -c 'ENV PATH=/miniconda3/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' -c 'ENV LC_ALL=C.UTF-8' -c 'ENV LANG=C.UTF-8' q2 qiime2/core:latest"
      ],
      "only": ["docker"]
    }
  ]
}
